

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>gseapy.gsea &mdash; GSEApy 0.9.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="GSEApy 0.9.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> GSEApy
          

          
          </a>

          
            
            
              <div class="version">
                0.9.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../introduction.html">Welcome to GSEAPY’s documentation!</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../run.html">How to Use GSEAPY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gseapy_tutorial.html">A Protocol to Prepare files for GSEAPY</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gseapy_example.html">GSEAPY Example</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">GSEApy</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>gseapy.gsea</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for gseapy.gsea</h1><div class="highlight"><pre>
<span></span><span class="ch">#! python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span><span class="nn">sys</span><span class="o">,</span><span class="nn">logging</span><span class="o">,</span><span class="nn">json</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Pool</span><span class="p">,</span> <span class="n">cpu_count</span>
<span class="kn">from</span> <span class="nn">numpy</span> <span class="k">import</span> <span class="n">number</span><span class="p">,</span> <span class="n">log</span><span class="p">,</span> <span class="n">exp</span>
<span class="kn">from</span> <span class="nn">gseapy.parser</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">gseapy.algorithm</span> <span class="k">import</span> <span class="n">enrichment_score</span><span class="p">,</span> <span class="n">gsea_compute</span><span class="p">,</span> <span class="n">gsea_compute_ss</span><span class="p">,</span> <span class="n">ranking_metric</span>
<span class="kn">from</span> <span class="nn">gseapy.plot</span> <span class="k">import</span> <span class="n">gsea_plot</span><span class="p">,</span> <span class="n">heatmap</span>
<span class="kn">from</span> <span class="nn">gseapy.utils</span> <span class="k">import</span> <span class="n">mkdirs</span>


<span class="k">class</span> <span class="nc">GSEAbase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;base class of GSEA.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gene_sets</span><span class="o">=</span><span class="s1">&#39;KEGG_2016&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">=</span><span class="s1">&#39;base&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">res2d</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranking</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processes</span><span class="o">=</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">=</span><span class="kc">None</span>

    <span class="k">def</span> <span class="nf">_log_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="s1">&#39;GSEA&#39;</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;logging start&quot;&quot;&quot;</span>

        <span class="c1"># clear old root logger handlers</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># log file naming rules</span>
        <span class="n">gene_set</span> <span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_sets</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;.gmt&quot;</span><span class="p">)</span>
        <span class="c1"># init a root logger</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span>    <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                            <span class="nb">format</span>   <span class="o">=</span> <span class="s1">&#39;LINE </span><span class="si">%(lineno)-4d</span><span class="s1">: </span><span class="si">%(asctime)s</span><span class="s1"> [</span><span class="si">%(levelname)-8s</span><span class="s1">] </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/gseapy.</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">.log&quot;</span><span class="o">%</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">gene_set</span><span class="p">),</span>
                            <span class="n">filemode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>

        <span class="c1"># define a Handler which writes INFO messages or higher to the sys.stderr</span>
        <span class="n">console</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="n">console</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">log_level</span><span class="p">)</span>
        <span class="c1"># set a format which is simpler for console use</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> </span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># tell the handler to use this format</span>
        <span class="n">console</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
        <span class="c1"># add handlers</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">console</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="c1">#logger.setLevel(log_level)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">=</span><span class="n">logger</span>
        <span class="k">return</span> <span class="n">logger</span>

    <span class="k">def</span> <span class="nf">_log_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;log stop&quot;&quot;&quot;</span>

        <span class="n">handlers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">handlers</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">handler</span> <span class="ow">in</span> <span class="n">handlers</span><span class="p">:</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">removeHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_cores</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;set cpu numbers to be used&quot;&quot;&quot;</span>

        <span class="n">cpu_num</span> <span class="o">=</span> <span class="n">cpu_count</span><span class="p">()</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processes</span> <span class="o">&gt;</span> <span class="n">cpu_num</span><span class="p">:</span>
            <span class="n">cores</span> <span class="o">=</span> <span class="n">cpu_num</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processes</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cores</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cores</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_processes</span>
        <span class="c1"># have to be int if user input is float</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cores</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_rank_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rnk</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse ranking file. This file contains ranking correlation vector( or expression values)</span>
<span class="sd">           and gene names or ids.</span>

<span class="sd">        :param rnk: the .rnk file of GSEA input or a pandas DataFrame, Series instance.</span>
<span class="sd">        :return: a pandas DataFrame with 3 columns names are: &#39;gene_name&#39;,&#39;rank&#39;,rank2&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#load data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rnk</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">rank_metric</span> <span class="o">=</span> <span class="n">rnk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># handle dataframe with gene_name as index.</span>
            <span class="k">if</span> <span class="n">rnk</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">rank_metric</span> <span class="o">=</span> <span class="n">rnk</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rnk</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">rank_metric</span> <span class="o">=</span> <span class="n">rnk</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">rnk</span><span class="p">):</span>
            <span class="n">rank_metric</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">rnk</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error parsing gene ranking values!&#39;</span><span class="p">)</span>

        <span class="c1">#sort ranking values from high to low</span>
        <span class="k">if</span> <span class="n">rank_metric</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span> <span class="c1"># if cols &gt; 2, means this is a expression matrixs of gct format</span>
            <span class="n">rank_metric</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">rank_metric</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ascending</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#drop na values</span>
        <span class="k">if</span> <span class="n">rank_metric</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Input gene rankings contains NA values(gene name and ranking value), drop them all!&quot;</span><span class="p">)</span>
            <span class="c1">#print out NAs</span>
            <span class="n">NAs</span> <span class="o">=</span> <span class="n">rank_metric</span><span class="p">[</span><span class="n">rank_metric</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;NAs list:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">NAs</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
            <span class="n">rank_metric</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;any&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1">#drop duplicate IDs, keep the first</span>
        <span class="k">if</span> <span class="n">rank_metric</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">rank_metric</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Input gene rankings contains duplicated IDs, Only use the duplicated ID with highest value!&quot;</span><span class="p">)</span>
            <span class="c1">#print out duplicated IDs.</span>
            <span class="n">dups</span> <span class="o">=</span> <span class="n">rank_metric</span><span class="p">[</span><span class="n">rank_metric</span><span class="o">.</span><span class="n">duplicated</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">rank_metric</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Dups list:</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">+</span><span class="n">dups</span><span class="o">.</span><span class="n">to_string</span><span class="p">())</span>
            <span class="n">rank_metric</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">rank_metric</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">rank_metric</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1">#reset ranking index, because you have sort values and drop duplicates.</span>
            <span class="n">rank_metric</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">rank_metric</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gene_name&#39;</span><span class="p">,</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranking</span> <span class="o">=</span> <span class="n">rank_metric</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>
            <span class="c1">#use for plotting, need 2d array</span>
            <span class="n">rank_metric</span><span class="p">[</span><span class="s1">&#39;rank2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rank_metric</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">rank_metric</span>

    <span class="k">def</span> <span class="nf">_plotting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rank_metric</span><span class="p">,</span> <span class="n">results</span><span class="p">,</span> <span class="n">res2d</span><span class="p">,</span>
                 <span class="n">graph_num</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phenoPos</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">phenoNeg</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param rank_metric: dat2.</span>
<span class="sd">        :param results: self.results</span>
<span class="sd">        :param data: preprocessed expression table</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#Plotting</span>
        <span class="n">top_term</span> <span class="o">=</span> <span class="n">res2d</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">graph_num</span><span class="p">)</span><span class="o">.</span><span class="n">index</span>

        <span class="c1">#multi-threading</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_processes</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">gs</span> <span class="ow">in</span> <span class="n">top_term</span><span class="p">:</span>
            <span class="n">hit</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gs</span><span class="p">)[</span><span class="s1">&#39;hit_index&#39;</span><span class="p">]</span>
            <span class="n">NES</span> <span class="o">=</span> <span class="s1">&#39;nes&#39;</span> <span class="k">if</span> <span class="n">module</span> <span class="o">!=</span> <span class="s1">&#39;ssgsea&#39;</span> <span class="k">else</span> <span class="s1">&#39;es&#39;</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            gsea_plot(rank_metric=rank_metric, enrich_term=gs, hit_ind=hit,</span>
<span class="sd">                      nes=results.get(gs)[&#39;nes&#39;], pval=results.get(gs)[&#39;pval&#39;], fdr=results.get(gs)[&#39;fdr&#39;],</span>
<span class="sd">                      RES=results.get(gs)[&#39;rank_ES&#39;], phenoPos=phenoPos, phenoNeg=phenoNeg, figsize=figsize,</span>
<span class="sd">                      format=format, outdir=outdir, module=module)</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">gsea_plot</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">rank_metric</span><span class="p">,</span> <span class="n">gs</span><span class="p">,</span> <span class="n">hit</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gs</span><span class="p">)[</span><span class="n">NES</span><span class="p">],</span>
                                              <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gs</span><span class="p">)[</span><span class="s1">&#39;pval&#39;</span><span class="p">],</span><span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gs</span><span class="p">)[</span><span class="s1">&#39;fdr&#39;</span><span class="p">],</span>
                                              <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gs</span><span class="p">)[</span><span class="s1">&#39;rank_ES&#39;</span><span class="p">],</span>
                                              <span class="n">phenoPos</span><span class="p">,</span> <span class="n">phenoNeg</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">))</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">module</span> <span class="o">==</span> <span class="s1">&#39;gsea&#39;</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">classes</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="k">else</span>  <span class="mi">5</span>
            <span class="n">cls_booA</span> <span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">phenoPos</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span> <span class="n">classes</span><span class="p">))</span>
            <span class="n">cls_booB</span> <span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">phenoNeg</span> <span class="k">else</span> <span class="kc">False</span><span class="p">,</span> <span class="n">classes</span><span class="p">))</span>
            <span class="n">datA</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cls_booA</span><span class="p">]</span>
            <span class="n">datB</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cls_booB</span><span class="p">]</span>
            <span class="n">datAB</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">datA</span><span class="p">,</span><span class="n">datB</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">pool_heat</span> <span class="o">=</span> <span class="n">Pool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_processes</span><span class="p">)</span>

            <span class="c1">#no values need to be returned</span>
            <span class="k">for</span> <span class="n">gs</span> <span class="ow">in</span> <span class="n">top_term</span><span class="p">:</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gs</span><span class="p">)[</span><span class="s1">&#39;hit_index&#39;</span><span class="p">]</span>
                <span class="n">pool_heat</span><span class="o">.</span><span class="n">apply_async</span><span class="p">(</span><span class="n">heatmap</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">datAB</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">hit</span><span class="p">],</span> <span class="n">gs</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                                                    <span class="p">(</span><span class="n">width</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="nb">format</span><span class="p">))</span>
                <span class="c1">#heatmap(datAB.iloc[hit], gs, outdir, 0, (width, len(hit)/2), format)</span>

            <span class="n">pool_heat</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool_heat</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_save_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">zipdata</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">module</span><span class="p">,</span> <span class="n">gmt</span><span class="p">,</span> <span class="n">rank_metric</span><span class="p">,</span> <span class="n">permutation_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;reformat gsea results, and save to txt&quot;&quot;&quot;</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">gs</span><span class="p">,</span><span class="n">gseale</span><span class="p">,</span><span class="n">ind</span><span class="p">,</span><span class="n">RES</span> <span class="ow">in</span> <span class="n">zipdata</span><span class="p">:</span>
            <span class="n">rdict</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
            <span class="n">rdict</span><span class="p">[</span><span class="s1">&#39;es&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gseale</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rdict</span><span class="p">[</span><span class="s1">&#39;nes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gseale</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">rdict</span><span class="p">[</span><span class="s1">&#39;pval&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gseale</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">rdict</span><span class="p">[</span><span class="s1">&#39;fdr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gseale</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">rdict</span><span class="p">[</span><span class="s1">&#39;gene_set_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">gmt</span><span class="p">[</span><span class="n">gs</span><span class="p">])</span>
            <span class="n">rdict</span><span class="p">[</span><span class="s1">&#39;matched_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ind</span><span class="p">)</span>
            <span class="c1">#reformat gene list.</span>
            <span class="n">_genes</span> <span class="o">=</span> <span class="n">rank_metric</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">ind</span><span class="p">,</span> <span class="n">rank_metric</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">get_loc</span><span class="p">(</span><span class="s1">&#39;gene_name&#39;</span><span class="p">)]</span>
            <span class="n">_genes</span> <span class="o">=</span> <span class="n">_genes</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">rdict</span><span class="p">[</span><span class="s1">&#39;genes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span> <span class="n">g</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">_genes</span> <span class="p">])</span>

            <span class="n">rdict</span><span class="p">[</span><span class="s1">&#39;rank_ES&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">RES</span>
            <span class="n">rdict</span><span class="p">[</span><span class="s1">&#39;hit_index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ind</span>
            <span class="n">res</span><span class="p">[</span><span class="n">gs</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdict</span>

        <span class="n">res_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">res_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Term&#39;</span>
        <span class="n">res_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;fdr&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">res_df</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;rank_ES&#39;</span><span class="p">,</span><span class="s1">&#39;hit_index&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">out</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{a}</span><span class="s1">/gseapy.</span><span class="si">{b}</span><span class="s1">.</span><span class="si">{c}</span><span class="s1">.report.csv&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">outdir</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">module</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">permutation_type</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span> <span class="o">==</span> <span class="s1">&#39;ssgsea&#39;</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# normalize enrichment scores by random permutation procddure</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# Same method to the orignial GSEA method, and it&#39;s not proper to use these values in your publication</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">res_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">res2d</span> <span class="o">=</span> <span class="n">res_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span>  <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">get_libraries</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;return enrichr active enrichr library name.Offical API &quot;&quot;&quot;</span>
        <span class="n">lib_url</span><span class="o">=</span><span class="s1">&#39;http://amp.pharm.mssm.edu/Enrichr/datasetStatistics&#39;</span>
        <span class="n">libs_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">lib_url</span><span class="p">)</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
        <span class="n">libs</span> <span class="o">=</span> <span class="p">[</span><span class="n">lib</span><span class="p">[</span><span class="s1">&#39;libraryName&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">lib</span> <span class="ow">in</span> <span class="n">libs_json</span><span class="p">[</span><span class="s1">&#39;statistics&#39;</span><span class="p">]]</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">libs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GSEA</span><span class="p">(</span><span class="n">GSEAbase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;GSEA main tool&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">gene_sets</span><span class="p">,</span> <span class="n">classes</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;GSEA_ouput&#39;</span><span class="p">,</span>
                 <span class="n">min_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">permutation_num</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                 <span class="n">weighted_score_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">permutation_type</span><span class="o">=</span><span class="s1">&#39;gene_set&#39;</span><span class="p">,</span>
                 <span class="n">method</span><span class="o">=</span><span class="s1">&#39;log2_ratio_of_classes&#39;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">graph_num</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                 <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gene_sets</span><span class="o">=</span><span class="n">gene_sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="o">=</span><span class="n">classes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permutation_type</span><span class="o">=</span><span class="n">permutation_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="o">=</span><span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permutation_num</span><span class="o">=</span><span class="n">permutation_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weighted_score_type</span><span class="o">=</span><span class="n">weighted_score_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processes</span><span class="o">=</span><span class="n">processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="o">=</span><span class="nb">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_num</span><span class="o">=</span><span class="n">graph_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">=</span><span class="s1">&#39;gsea&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranking</span><span class="o">=</span><span class="kc">None</span>
    <span class="k">def</span> <span class="nf">__drop_dat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">cls_vector</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;pre-processed the data frame.new filtering methods will be implement here.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1">#drop duplicate gene_names.</span>
        <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                     <span class="c1">#drop rows with all NAs</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">number</span><span class="p">])</span>

        <span class="c1">#drop any genes which std ==0</span>
        <span class="n">df_std</span> <span class="o">=</span>  <span class="n">df2</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">cls_vector</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">df2</span> <span class="o">=</span>  <span class="n">df2</span><span class="p">[</span><span class="o">~</span><span class="n">df_std</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)]</span>
        <span class="n">df2</span> <span class="o">=</span> <span class="n">df2</span> <span class="o">+</span> <span class="mf">0.00001</span> <span class="c1"># we don&#39;t like zeros!!!</span>

        <span class="k">return</span> <span class="n">df2</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;GSEA main procedure&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">permutation_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;phenotype&quot;</span><span class="p">,</span> <span class="s2">&quot;gene_set&quot;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="p">:</span>
            <span class="c1"># GCT input format?</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;gct&quot;</span><span class="p">):</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error parsing gene expression dataframe!&#39;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#data frame must have lenght &gt; 1</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="c1"># creat output dirs</span>
        <span class="n">mkdirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_init</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                               <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="c1">#Start Analysis</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parsing data files for GSEA.............................&quot;</span><span class="p">)</span>

        <span class="c1"># phenotype labels parsing</span>
        <span class="n">phenoPos</span><span class="p">,</span> <span class="n">phenoNeg</span><span class="p">,</span> <span class="n">cls_vector</span> <span class="o">=</span> <span class="n">gsea_cls_parser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classes</span><span class="p">)</span>
        <span class="c1">#select correct expression genes and values.</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__drop_dat</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">cls_vector</span><span class="p">)</span>
        <span class="c1">#ranking metrics calculation.</span>
        <span class="n">dat2</span> <span class="o">=</span> <span class="n">ranking_metric</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span> <span class="n">phenoPos</span><span class="o">=</span><span class="n">phenoPos</span><span class="p">,</span> <span class="n">phenoNeg</span><span class="o">=</span><span class="n">phenoNeg</span><span class="p">,</span>
                              <span class="n">classes</span><span class="o">=</span><span class="n">cls_vector</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ascending</span><span class="p">)</span>

        <span class="c1">#filtering out gene sets and build gene sets dictionary</span>
        <span class="n">gmt</span> <span class="o">=</span> <span class="n">gsea_gmt_parser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_sets</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_size</span><span class="p">,</span>
                              <span class="n">gene_list</span><span class="o">=</span><span class="n">dat2</span><span class="p">[</span><span class="s1">&#39;gene_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%04d</span><span class="s2"> gene_sets used for further statistical testing.....&quot;</span><span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gmt</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start to run GSEA...Might take a while..................&quot;</span><span class="p">)</span>
        <span class="c1">#cpu numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_cores</span><span class="p">()</span>
        <span class="c1">#compute ES, NES, pval, FDR, RES</span>
        <span class="n">gsea_results</span><span class="p">,</span><span class="n">hit_ind</span><span class="p">,</span><span class="n">rank_ES</span><span class="p">,</span> <span class="n">subsets</span> <span class="o">=</span> <span class="n">gsea_compute</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">permutation_num</span><span class="p">,</span> <span class="n">gmt</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span>
                                                             <span class="n">weighted_score_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weighted_score_type</span><span class="p">,</span>
                                                             <span class="n">permutation_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">permutation_type</span><span class="p">,</span>
                                                             <span class="n">method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
                                                             <span class="n">phenoPos</span><span class="o">=</span><span class="n">phenoPos</span><span class="p">,</span> <span class="n">phenoNeg</span><span class="o">=</span><span class="n">phenoNeg</span><span class="p">,</span>
                                                             <span class="n">classes</span><span class="o">=</span><span class="n">cls_vector</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ascending</span><span class="p">,</span>
                                                             <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_processes</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start to generate gseapy reports, and produce figures...&quot;</span><span class="p">)</span>
        <span class="n">res_zip</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subsets</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">gsea_results</span><span class="p">),</span> <span class="n">hit_ind</span><span class="p">,</span> <span class="n">rank_ES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_results</span><span class="p">(</span><span class="n">zipdata</span><span class="o">=</span><span class="n">res_zip</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                                   <span class="n">gmt</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span> <span class="n">rank_metric</span><span class="o">=</span><span class="n">dat2</span><span class="p">,</span> <span class="n">permutation_type</span><span class="o">=</span><span class="s2">&quot;gene_sets&quot;</span><span class="p">)</span>

        <span class="c1">#Plotting</span>
        <span class="n">heat_dat</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dat2</span><span class="o">.</span><span class="n">gene_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plotting</span><span class="p">(</span><span class="n">rank_metric</span><span class="o">=</span><span class="n">dat2</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">res2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">res2d</span><span class="p">,</span>
                       <span class="n">graph_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_num</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
                       <span class="n">figsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">figsize</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                       <span class="n">data</span><span class="o">=</span><span class="n">heat_dat</span><span class="p">,</span> <span class="n">classes</span><span class="o">=</span><span class="n">cls_vector</span><span class="p">,</span> <span class="n">phenoPos</span><span class="o">=</span><span class="n">phenoPos</span><span class="p">,</span> <span class="n">phenoNeg</span><span class="o">=</span><span class="n">phenoNeg</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Congratulations. GSEApy run successfully................</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span>


<span class="k">class</span> <span class="nc">Prerank</span><span class="p">(</span><span class="n">GSEAbase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;GSEA prerank tool&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rnk</span><span class="p">,</span> <span class="n">gene_sets</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;GSEA_prerank&#39;</span><span class="p">,</span>
                 <span class="n">pheno_pos</span><span class="o">=</span><span class="s1">&#39;Pos&#39;</span><span class="p">,</span> <span class="n">pheno_neg</span><span class="o">=</span><span class="s1">&#39;Neg&#39;</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                 <span class="n">permutation_num</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">weighted_score_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                 <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span>
                 <span class="n">graph_num</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rnk</span> <span class="o">=</span><span class="n">rnk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gene_sets</span><span class="o">=</span><span class="n">gene_sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pheno_pos</span><span class="o">=</span><span class="n">pheno_pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pheno_neg</span><span class="o">=</span><span class="n">pheno_neg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permutation_num</span><span class="o">=</span><span class="n">permutation_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weighted_score_type</span><span class="o">=</span><span class="n">weighted_score_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="o">=</span><span class="nb">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_num</span><span class="o">=</span><span class="n">graph_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranking</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">=</span><span class="s1">&#39;prerank&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processes</span><span class="o">=</span><span class="n">processes</span>


    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;GSEA prerank workflow&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span>
        <span class="n">mkdirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_init</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                               <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="c1">#parsing rankings</span>
        <span class="n">dat2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rank_metric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rnk</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">dat2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="c1">#cpu numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_cores</span><span class="p">()</span>
        <span class="c1">#Start Analysis</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parsing data files for GSEA.............................&quot;</span><span class="p">)</span>
        <span class="c1">#filtering out gene sets and build gene sets dictionary</span>
        <span class="n">gmt</span> <span class="o">=</span> <span class="n">gsea_gmt_parser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_sets</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_size</span><span class="p">,</span>
                              <span class="n">gene_list</span><span class="o">=</span><span class="n">dat2</span><span class="p">[</span><span class="s1">&#39;gene_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%04d</span><span class="s2"> gene_sets used for further statistical testing.....&quot;</span><span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gmt</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start to run GSEA...Might take a while..................&quot;</span><span class="p">)</span>
        <span class="c1">#compute ES, NES, pval, FDR, RES</span>
        <span class="n">gsea_results</span><span class="p">,</span> <span class="n">hit_ind</span><span class="p">,</span><span class="n">rank_ES</span><span class="p">,</span> <span class="n">subsets</span> <span class="o">=</span> <span class="n">gsea_compute</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat2</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">permutation_num</span><span class="p">,</span> <span class="n">gmt</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span>
                                                              <span class="n">weighted_score_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weighted_score_type</span><span class="p">,</span>
                                                              <span class="n">permutation_type</span><span class="o">=</span><span class="s1">&#39;gene_set&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                              <span class="n">phenoPos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pheno_pos</span><span class="p">,</span> <span class="n">phenoNeg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pheno_neg</span><span class="p">,</span>
                                                              <span class="n">classes</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ascending</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                                                              <span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_processes</span><span class="p">,</span> <span class="n">prerank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start to generate gseapy reports, and produce figures...&quot;</span><span class="p">)</span>
        <span class="n">res_zip</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subsets</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">gsea_results</span><span class="p">),</span> <span class="n">hit_ind</span><span class="p">,</span> <span class="n">rank_ES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_save_results</span><span class="p">(</span><span class="n">zipdata</span><span class="o">=</span><span class="n">res_zip</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                                   <span class="n">gmt</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span> <span class="n">rank_metric</span><span class="o">=</span><span class="n">dat2</span><span class="p">,</span> <span class="n">permutation_type</span><span class="o">=</span><span class="s2">&quot;gene_sets&quot;</span><span class="p">)</span>

        <span class="c1">#Plotting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plotting</span><span class="p">(</span><span class="n">rank_metric</span><span class="o">=</span><span class="n">dat2</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">res2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">res2d</span><span class="p">,</span>
                       <span class="n">graph_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_num</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
                       <span class="n">figsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">figsize</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
                       <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span> <span class="n">phenoPos</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pheno_pos</span><span class="p">,</span> <span class="n">phenoNeg</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pheno_neg</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Congratulations. GSEApy run successfully................</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span>


<span class="k">class</span> <span class="nc">SingleSampleGSEA</span><span class="p">(</span><span class="n">GSEAbase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;GSEA extention: single sample GSEA&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">gene_sets</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;GSEA_SingleSample&quot;</span><span class="p">,</span> <span class="n">sample_norm_method</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span>
                 <span class="n">min_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span> <span class="n">permutation_num</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">weighted_score_type</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                 <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span>
                 <span class="n">graph_num</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">=</span><span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gene_sets</span><span class="o">=</span><span class="n">gene_sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_norm_method</span><span class="o">=</span><span class="n">sample_norm_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weighted_score_type</span><span class="o">=</span><span class="n">weighted_score_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="o">=</span> <span class="n">scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">permutation_num</span><span class="o">=</span><span class="n">permutation_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ascending</span><span class="o">=</span><span class="n">ascending</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="o">=</span><span class="nb">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph_num</span><span class="o">=</span><span class="n">graph_num</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ranking</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">=</span><span class="s1">&#39;ssgsea&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_processes</span><span class="o">=</span><span class="n">processes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imat</span><span class="o">=</span><span class="kc">None</span>

    <span class="k">def</span> <span class="nf">corplot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;NES Correlation plot</span>
<span class="sd">        &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">setplot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ranked genes&#39; location plot</span>
<span class="sd">        &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">load_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#load data</span>
        <span class="n">rnk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rnk</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="n">rank_metric</span> <span class="o">=</span> <span class="n">rnk</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># handle dataframe with gene_name as index.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Input data is a DataFrame with gene names&quot;</span><span class="p">)</span>
            <span class="c1">#handle index is not gene_names</span>
            <span class="k">if</span> <span class="n">rank_metric</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="s1">&#39;O&#39;</span><span class="p">:</span>
                <span class="n">rank_metric</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">keys</span><span class="o">=</span><span class="n">rank_metric</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">rank_metric</span> <span class="o">=</span> <span class="n">rank_metric</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">number</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rnk</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="c1">#change to DataFrame</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Input data is a Series with gene names&quot;</span><span class="p">)</span>
            <span class="n">rank_metric</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">rnk</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">rnk</span><span class="p">):</span>
            <span class="c1"># GCT input format?</span>
            <span class="k">if</span> <span class="n">rnk</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;gct&quot;</span><span class="p">):</span>
                <span class="n">rank_metric</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">rnk</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1">#just rnk file input</span>
                <span class="n">rank_metric</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">rnk</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rank_metric</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span><span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># txt file input</span>
                    <span class="n">rank_metric</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="n">rnk</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="c1">#select numbers</span>
            <span class="n">rank_metric</span> <span class="o">=</span> <span class="n">rank_metric</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="n">number</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error parsing gene ranking values!&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rank_metric</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Warning: dropping duplicated gene names, only keep the first values&quot;</span><span class="p">)</span>
            <span class="n">rank_metric</span> <span class="o">=</span> <span class="n">rank_metric</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rank_metric</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">keep</span><span class="o">=</span><span class="s1">&#39;first&#39;</span><span class="p">)]</span>
        <span class="c1"># if single sample input, set ranking is not None for temp.</span>
        <span class="k">if</span> <span class="n">rank_metric</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ranking</span><span class="o">=</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">rank_metric</span>

    <span class="k">def</span> <span class="nf">norm_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dat</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;normalizatin samples</span>
<span class="sd">           see here: http://rowley.mit.edu/caw_web/ssGSEAProjection/ssGSEAProjection.Library.R</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#set index of gene_names</span>
        <span class="c1">#data = self.data.set_index(keys=data.columns[0], inplace=True)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_norm_method</span> <span class="o">==</span> <span class="s1">&#39;rank&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="n">na_option</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">*</span><span class="n">data</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_norm_method</span> <span class="o">==</span> <span class="s1">&#39;log_rank&#39;</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">dat</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;average&#39;</span><span class="p">,</span> <span class="n">na_option</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="mi">10000</span><span class="o">*</span><span class="n">data</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_norm_method</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">dat</span><span class="p">[</span><span class="n">dat</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="n">dat</span> <span class="o">+</span> <span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_norm_method</span> <span class="o">==</span> <span class="s1">&#39;custom&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Set user defined rank metric for ssGSEA&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;No supported method: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_norm_type</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mkdirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_init</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                                <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="c1">#load data</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_data</span><span class="p">()</span>

        <span class="c1"># normalized samples, and rank</span>
        <span class="n">normdat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">norm_samples</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># logic to process gct expression matrix</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ranking</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1">#gct expression matrix support for ssGSEA</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runOnSamples</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">normdat</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#only for one sample</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runSample</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">normdat</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">runSample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">gmt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">multisamples</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Single Sample GSEA workflow&quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span>

        <span class="n">mkdirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>

        <span class="c1">#Start Analysis</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Parsing data files for GSEA.............................&quot;</span><span class="p">)</span>
        <span class="c1">#select correct expression genes and values.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Error parsing gene ranking values!&#39;</span><span class="p">)</span>

        <span class="c1">#sort ranking values from high to low or reverse</span>
        <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ascending</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gene_name&#39;</span><span class="p">,</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rank2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>
        <span class="c1">#reset interger index, or caused unwanted problems</span>
        <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># revmove rank2</span>
        <span class="n">dat2</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;gene_name&#39;</span><span class="p">)</span>
        <span class="n">dat2</span> <span class="o">=</span> <span class="n">dat2</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span>
        <span class="c1">#cpu numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_cores</span><span class="p">()</span>
        <span class="c1">#filtering out gene sets and build gene sets dictionary</span>
        <span class="k">if</span> <span class="n">gmt</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gmt</span> <span class="o">=</span> <span class="n">gsea_gmt_parser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_sets</span><span class="p">,</span>
                                  <span class="n">min_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="p">,</span>
                                  <span class="n">max_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_size</span><span class="p">,</span>
                                  <span class="n">gene_list</span><span class="o">=</span><span class="n">dat2</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%04d</span><span class="s2"> gene_sets used for further statistical testing.....&quot;</span><span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="n">gmt</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start to run GSEA...Might take a while..................&quot;</span><span class="p">)</span>
        <span class="c1">#compute ES, NES, pval, FDR, RES</span>
        <span class="n">gsea_results</span><span class="p">,</span> <span class="n">hit_ind</span><span class="p">,</span> <span class="n">rank_ES</span><span class="p">,</span> <span class="n">subsets</span> <span class="o">=</span> <span class="n">gsea_compute_ss</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">dat2</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">permutation_num</span><span class="p">,</span>
                                                                  <span class="n">gmt</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span>
                                                                  <span class="n">weighted_score_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weighted_score_type</span><span class="p">,</span>
                                                                  <span class="n">scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scale</span><span class="p">,</span>
                                                                  <span class="n">seed</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
                                                                  <span class="n">processes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_processes</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Start to generate gseapy reports, and produce figures...&quot;</span><span class="p">)</span>
        <span class="n">res_zip</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">subsets</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">gsea_results</span><span class="p">),</span> <span class="n">hit_ind</span><span class="p">,</span> <span class="n">rank_ES</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_save_results</span><span class="p">(</span><span class="n">zipdata</span><span class="o">=</span><span class="n">res_zip</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                                   <span class="n">gmt</span><span class="o">=</span><span class="n">gmt</span><span class="p">,</span> <span class="n">rank_metric</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">permutation_type</span><span class="o">=</span><span class="s2">&quot;gene_sets&quot;</span><span class="p">)</span>

        <span class="c1">#Plotting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imat</span> <span class="o">=</span> <span class="n">df</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">multisamples</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plotting</span><span class="p">(</span><span class="n">rank_metric</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">,</span> <span class="n">res2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">res2d</span><span class="p">,</span>
                           <span class="n">graph_num</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">graph_num</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span>
                           <span class="n">figsize</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">figsize</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Congratulations. GSEApy run successfully................</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">runOnSamples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;ssGSEA for gct expression matrix</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># df.index.values are gene_names</span>
        <span class="c1">#filtering out gene sets and build gene sets dictionary</span>
        <span class="n">gmt</span> <span class="o">=</span> <span class="n">gsea_gmt_parser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gene_sets</span><span class="p">,</span>
                              <span class="n">min_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="p">,</span>
                              <span class="n">max_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_size</span><span class="p">,</span>
                              <span class="n">gene_list</span><span class="o">=</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>

        <span class="c1">#Save each sample results to ordereddict</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resultsOnSamples</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">outdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span>
        <span class="c1">#run ssgsea for gct expression matrixs</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">ser</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Run Sample: </span><span class="si">%s</span><span class="s2"> &quot;</span><span class="o">%</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runSample</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">ser</span><span class="p">,</span> <span class="n">gmt</span><span class="o">=</span><span class="n">gmt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">resultsOnSamples</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">res2d</span><span class="o">.</span><span class="n">es</span>
        <span class="c1">#save raw ES to one csv file</span>
        <span class="n">samplesRawES</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resultsOnSamples</span><span class="p">)</span>
        <span class="n">samplesRawES</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Term&#39;</span>
        <span class="c1"># write es</span>
        <span class="n">outESfile</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;gseapy.samples.raw.es.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outESfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale</span> <span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# scale the enrichment scores by number of genes in the gene sets</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# this normalization has not effects on the finall NES &#39;</span> <span class="o">+</span>\
                        <span class="s1">&#39;as indicated by Barbie et al., 2009, online methods, pg. 2</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# raw enrichment scores of all data</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# no scale es by numbers of genes in the gene sets</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">samplesRawES</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1">## normalize enrichment scores by using the entire data set, as indicated</span>
        <span class="c1">## by Barbie et al., 2009, online methods, pg. 2</span>
        <span class="n">samplesNES</span> <span class="o">=</span> <span class="n">samplesRawES</span> <span class="o">/</span> <span class="p">(</span><span class="n">samplesRawES</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">samplesRawES</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">outNESfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="s2">&quot;gseapy.samples.normalized.es.txt&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">outNESfile</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# normalize enrichment scores by using the entire data set</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# as indicated by Barbie et al., 2009, online methods, pg. 2</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">samplesNES</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span>


<span class="k">class</span> <span class="nc">Replot</span><span class="p">(</span><span class="n">GSEAbase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;To Reproduce GSEA desktop output results.&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indir</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;GSEApy_Replot&#39;</span><span class="p">,</span> <span class="n">weighted_score_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                  <span class="n">min_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">=</span><span class="n">indir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="o">=</span><span class="n">outdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">weighted_score_type</span><span class="o">=</span><span class="n">weighted_score_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="o">=</span><span class="n">min_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span><span class="o">=</span><span class="n">max_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="o">=</span><span class="nb">format</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="o">=</span><span class="s1">&#39;replot&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gene_sets</span><span class="o">=</span><span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;main replot function&quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">min_size</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_size</span>

        <span class="kn">import</span> <span class="nn">glob</span>
        <span class="kn">from</span> <span class="nn">bs4</span> <span class="k">import</span> <span class="n">BeautifulSoup</span>

        <span class="c1">#parsing files.......</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">results_path</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">+</span><span class="s1">&#39;*/edb/results.edb&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">rank_path</span> <span class="o">=</span>  <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">+</span><span class="s1">&#39;*/edb/*.rnk&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">gene_set_path</span> <span class="o">=</span>  <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">+</span><span class="s1">&#39;*/edb/gene_sets.gmt&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1">#logger.debug(e)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Could not locate GSEA files in the given directory!&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c1">#extract sample names from .cls file</span>
        <span class="n">cls_path</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indir</span><span class="o">+</span><span class="s1">&#39;*/edb/*.cls&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cls_path</span><span class="p">:</span>
            <span class="n">phenoPos</span><span class="p">,</span> <span class="n">phenoNeg</span><span class="p">,</span> <span class="n">classes</span> <span class="o">=</span> <span class="n">gsea_cls_parser</span><span class="p">(</span><span class="n">cls_path</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># logic for prerank results</span>
            <span class="n">phenoPos</span><span class="p">,</span> <span class="n">phenoNeg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span>
        <span class="c1">#start reploting</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gene_sets</span><span class="o">=</span><span class="n">gene_set_path</span>
        <span class="n">mkdirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">)</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_log_init</span><span class="p">(</span><span class="n">module</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">,</span>
                                <span class="n">log_level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="k">else</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>

        <span class="c1">#obtain gene sets</span>
        <span class="n">gene_set_dict</span> <span class="o">=</span> <span class="n">gsea_gmt_parser</span><span class="p">(</span><span class="n">gene_set_path</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_size</span><span class="p">)</span>
        <span class="c1">#obtain rank_metrics</span>
        <span class="n">rank_metric</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rank_metric</span><span class="p">(</span><span class="n">rank_path</span><span class="p">)</span>
        <span class="n">correl_vector</span> <span class="o">=</span>  <span class="n">rank_metric</span><span class="p">[</span><span class="s1">&#39;rank&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">gene_list</span> <span class="o">=</span> <span class="n">rank_metric</span><span class="p">[</span><span class="s1">&#39;gene_name&#39;</span><span class="p">]</span>
        <span class="c1">#extract each enriment term in the results.edb files and plot.</span>
        <span class="n">database</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">results_path</span><span class="p">),</span> <span class="n">features</span><span class="o">=</span><span class="s1">&#39;xml&#39;</span><span class="p">)</span>
        <span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">database</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="s1">&#39;DTG&#39;</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
            <span class="c1">#extract statistical resutls from results.edb file</span>
            <span class="n">enrich_term</span><span class="p">,</span> <span class="n">hit_ind</span><span class="p">,</span> <span class="n">nes</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span> <span class="n">fdr</span><span class="o">=</span> <span class="n">gsea_edb_parser</span><span class="p">(</span><span class="n">results_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">gene_set</span> <span class="o">=</span> <span class="n">gene_set_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">enrich_term</span><span class="p">)</span>
            <span class="c1">#calculate enrichment score</span>
            <span class="n">RES</span> <span class="o">=</span> <span class="n">enrichment_score</span><span class="p">(</span><span class="n">gene_list</span><span class="o">=</span><span class="n">gene_list</span><span class="p">,</span> <span class="n">gene_set</span><span class="o">=</span><span class="n">gene_set</span><span class="p">,</span>
                                   <span class="n">weighted_score_type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">weighted_score_type</span><span class="p">,</span>
                                   <span class="n">correl_vector</span><span class="o">=</span><span class="n">correl_vector</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="c1">#plotting</span>
            <span class="n">gsea_plot</span><span class="p">(</span><span class="n">rank_metric</span><span class="p">,</span> <span class="n">enrich_term</span><span class="p">,</span> <span class="n">hit_ind</span><span class="p">,</span> <span class="n">nes</span><span class="p">,</span> <span class="n">pval</span><span class="p">,</span>
                            <span class="n">fdr</span><span class="p">,</span> <span class="n">RES</span><span class="p">,</span> <span class="n">phenoPos</span><span class="p">,</span> <span class="n">phenoNeg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">figsize</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">format</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outdir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">module</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Congratulations! Your plots have been reproduced successfully!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">gene_sets</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;GSEA_&#39;</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">permutation_num</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
          <span class="n">weighted_score_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">permutation_type</span><span class="o">=</span><span class="s1">&#39;gene_set&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;log2_ratio_of_classes&#39;</span><span class="p">,</span>
      <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">graph_num</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;DeprecationWarning: &quot;</span><span class="o">+</span>\
                     <span class="s2">&quot;call function has been deprecated, plesea use gseapy.gsea() instead.&quot;</span><span class="p">)</span>

    <span class="k">return</span>


<div class="viewcode-block" id="gsea"><a class="viewcode-back" href="../../run.html#gseapy.gsea">[docs]</a><span class="k">def</span> <span class="nf">gsea</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">gene_sets</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;GSEA_&#39;</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">permutation_num</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
          <span class="n">weighted_score_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">permutation_type</span><span class="o">=</span><span class="s1">&#39;gene_set&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;log2_ratio_of_classes&#39;</span><span class="p">,</span>
	  <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">graph_num</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Run Gene Set Enrichment Analysis.</span>

<span class="sd">    :param data: Gene expression data table, pandas DataFrame, gct file.</span>
<span class="sd">    :param gene_sets: Enrichr Library name or .gmt gene sets file. Same input with GSEA.</span>
<span class="sd">    :param cls: a list or a .cls file format required for GSEA.</span>
<span class="sd">    :param str outdir: Results output directory.</span>
<span class="sd">    :param int permutation_num: Number of permutations for significance computation. Default: 1000.</span>
<span class="sd">    :param str permutation_type: Permutation type, &quot;phenotype&quot; for phenotypes, &quot;gene_set&quot; for genes.</span>
<span class="sd">    :param int min_size: Minimum allowed number of genes from gene set also the data set. Defaut: 15.</span>
<span class="sd">    :param int max_size: Maximum allowed number of genes from gene set also the data set. Defaults: 500.</span>
<span class="sd">    :param float weighted_score_type: Refer to :func:`algorithm.enrichment_socre`. Default:1.</span>
<span class="sd">    :param method:  The method used to calculate a correlation or ranking. Default: &#39;log2_ratio_of_classes&#39;.</span>
<span class="sd">                   Others methods are:</span>

<span class="sd">                   1. &#39;signal_to_noise&#39;</span>

<span class="sd">                      You must have at least three samples for each phenotype to use this metric.</span>
<span class="sd">                      The larger the signal-to-noise ratio, the larger the differences of the means (scaled by the standard deviations);</span>
<span class="sd">                      that is, the more distinct the gene expression is in each phenotype and the more the gene acts as a “class marker.”</span>

<span class="sd">                   2. &#39;t_test&#39;</span>

<span class="sd">                      Uses the difference of means scaled by the standard deviation and number of samples.</span>
<span class="sd">                      Note: You must have at least three samples for each phenotype to use this metric.</span>
<span class="sd">                      The larger the tTest ratio, the more distinct the gene expression is in each phenotype</span>
<span class="sd">                      and the more the gene acts as a “class marker.”</span>

<span class="sd">                   3. &#39;ratio_of_classes&#39; (also referred to as fold change).</span>

<span class="sd">                      Uses the ratio of class means to calculate fold change for natural scale data.</span>

<span class="sd">                   4. &#39;diff_of_classes&#39;</span>


<span class="sd">                      Uses the difference of class means to calculate fold change for nature scale data</span>


<span class="sd">                   5. &#39;log2_ratio_of_classes&#39;</span>

<span class="sd">                      Uses the log2 ratio of class means to calculate fold change for natural scale data.</span>
<span class="sd">                      This is the recommended statistic for calculating fold change for log scale data.</span>


<span class="sd">    :param bool ascending: Sorting order of rankings. Default: False.</span>
<span class="sd">    :param int processes: Number of Processes you are going to use. Default: 1.</span>
<span class="sd">    :param list figsize: Matplotlib figsize, accept a tuple or list, e.g. [width,height]. Default: [6.5,6].</span>
<span class="sd">    :param str format: Matplotlib figure format. Default: &#39;pdf&#39;.</span>
<span class="sd">    :param int graph_num: Plot graphs for top sets of each phenotype</span>
<span class="sd">    :param seed: Random seed. expect an interger. Defalut:None.</span>
<span class="sd">    :param bool verbose: Bool, increase output verbosity, print out progress of your job, Default: False.</span>

<span class="sd">    :return: Return a GSEA obj. All results store to a dictionary, obj.results,</span>
<span class="sd">             where contains::</span>

<span class="sd">                 | {es: enrichment score,</span>
<span class="sd">                 |  nes: normalized enrichment score,</span>
<span class="sd">                 |  p: P-value,</span>
<span class="sd">                 |  fdr: FDR,</span>
<span class="sd">                 |  size: gene set size,</span>
<span class="sd">                 |  matched_size: genes matched to the data,</span>
<span class="sd">                 |  genes: gene names from the data set}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gs</span> <span class="o">=</span> <span class="n">GSEA</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">gene_sets</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">permutation_num</span><span class="p">,</span>
              <span class="n">weighted_score_type</span><span class="p">,</span> <span class="n">permutation_type</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">ascending</span><span class="p">,</span> <span class="n">processes</span><span class="p">,</span>
               <span class="n">figsize</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">graph_num</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">gs</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">gs</span></div>


<div class="viewcode-block" id="ssgsea"><a class="viewcode-back" href="../../run.html#gseapy.ssgsea">[docs]</a><span class="k">def</span> <span class="nf">ssgsea</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">gene_sets</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s2">&quot;GSEA_SingleSample&quot;</span><span class="p">,</span> <span class="n">sample_norm_method</span><span class="o">=</span><span class="s1">&#39;rank&#39;</span><span class="p">,</span> <span class="n">min_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
           <span class="n">permutation_num</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">weighted_score_type</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
           <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">7</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">graph_num</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run Gene Set Enrichment Analysis with single sample GSEA tool</span>

<span class="sd">    :param data: expression table, pd.Series, pd.DataFrame, GCT file, or .rnk file formate.</span>
<span class="sd">    :param gene_sets: Enrichr Library name or .gmt gene sets file. Same input with GSEA.</span>
<span class="sd">    :param outdir: results output directory.</span>
<span class="sd">    :param str sample_norm_method: &quot;Sample normalization method. Choose from {&#39;rank&#39;, &#39;log&#39;, &#39;log_rank&#39;}. Default: rank.</span>

<span class="sd">               1. &#39;rank&#39;: Rank your expression data, and transformed by 10000*rank_dat/gene_numbers</span>
<span class="sd">               2. &#39;log&#39; : Do not rank, but transformed data by log(data + exp(1)), while  data = data[data&lt;1] =1.</span>
<span class="sd">               3. &#39;log_rank&#39;: Rank your expression data, and transformed by log(10000*rank_dat/gene_numbers+ exp(1))</span>
<span class="sd">               4. &#39;custom&#39;: Do nothing, and use your own rank value to calulate enrichment score.</span>
<span class="sd">               see here: https://github.com/GSEA-MSigDB/ssGSEAProjection-gpmodule/blob/master/src/ssGSEAProjection.Library.R, line 86</span>

<span class="sd">    :param int min_size: Minimum allowed number of genes from gene set also the data set. Defaut: 15.</span>
<span class="sd">    :param int max_size: Maximum allowed number of genes from gene set also the data set. Defaults: 2000.</span>
<span class="sd">    :param int permutation_num: Number of permutations for significance computation. Default: 1000.</span>
<span class="sd">    :param str weighted_score_type: Refer to :func:`algorithm.enrichment_socre`. Default:0.25.</span>
<span class="sd">    :param bool scale: If True, normalize the scores by number of genes in the gene sets.</span>
<span class="sd">    :param bool ascending: Sorting order of rankings. Default: False.</span>
<span class="sd">    :param int processes: Number of Processes you are going to use. Default: 1.</span>
<span class="sd">    :param list figsize: Matplotlib figsize, accept a tuple or list, e.g. [width,height]. Default: [7,6].</span>
<span class="sd">    :param str format: Matplotlib figure format. Default: &#39;pdf&#39;.</span>
<span class="sd">    :param int graph_num: Plot graphs for top sets of each phenotype</span>
<span class="sd">    :param seed: Random seed. expect an interger. Defalut:None.</span>
<span class="sd">    :param bool verbose: Bool, increase output verbosity, print out progress of your job, Default: False.</span>

<span class="sd">    :return: Return a ssGSEA obj. All results store to  a dictionary, obj.results,</span>
<span class="sd">             where contains::</span>

<span class="sd">                 | {es: enrichment score,</span>
<span class="sd">                 |  nes: normalized enrichment score,</span>
<span class="sd">                 |  p: P-value,</span>
<span class="sd">                 |  fdr: FDR,</span>
<span class="sd">                 |  size: gene set size,</span>
<span class="sd">                 |  matched_size: genes matched to the data,</span>
<span class="sd">                 |  genes: gene names from the data set}</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ss</span> <span class="o">=</span> <span class="n">SingleSampleGSEA</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">gene_sets</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">sample_norm_method</span><span class="p">,</span> <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span>
                          <span class="n">permutation_num</span><span class="p">,</span> <span class="n">weighted_score_type</span><span class="p">,</span> <span class="n">scale</span><span class="p">,</span> <span class="n">ascending</span><span class="p">,</span>
                          <span class="n">processes</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">graph_num</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">ss</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">ss</span></div>


<div class="viewcode-block" id="prerank"><a class="viewcode-back" href="../../run.html#gseapy.prerank">[docs]</a><span class="k">def</span> <span class="nf">prerank</span><span class="p">(</span><span class="n">rnk</span><span class="p">,</span> <span class="n">gene_sets</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;GSEA_Prerank&#39;</span><span class="p">,</span> <span class="n">pheno_pos</span><span class="o">=</span><span class="s1">&#39;Pos&#39;</span><span class="p">,</span> <span class="n">pheno_neg</span><span class="o">=</span><span class="s1">&#39;Neg&#39;</span><span class="p">,</span>
            <span class="n">min_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">permutation_num</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">weighted_score_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span>
            <span class="n">graph_num</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Run Gene Set Enrichment Analysis with pre-ranked correlation defined by user.</span>

<span class="sd">    :param rnk: pre-ranked correlation table or pandas DataFrame. Same input with ``GSEA`` .rnk file.</span>
<span class="sd">    :param gene_sets: Enrichr Library name or .gmt gene sets file. Same input with GSEA.</span>
<span class="sd">    :param outdir: results output directory.</span>
<span class="sd">    :param int permutation_num: Number of permutations for significance computation. Default: 1000.</span>
<span class="sd">    :param int min_size: Minimum allowed number of genes from gene set also the data set. Defaut: 15.</span>
<span class="sd">    :param int max_size: Maximum allowed number of genes from gene set also the data set. Defaults: 500.</span>
<span class="sd">    :param str weighted_score_type: Refer to :func:`algorithm.enrichment_socre`. Default:1.</span>
<span class="sd">    :param bool ascending: Sorting order of rankings. Default: False.</span>
<span class="sd">    :param int processes: Number of Processes you are going to use. Default: 1.</span>
<span class="sd">    :param list figsize: Matplotlib figsize, accept a tuple or list, e.g. [width,height]. Default: [6.5,6].</span>
<span class="sd">    :param str format: Matplotlib figure format. Default: &#39;pdf&#39;.</span>
<span class="sd">    :param int graph_num: Plot graphs for top sets of each phenotype</span>
<span class="sd">    :param seed: Random seed. expect an interger. Defalut:None.</span>
<span class="sd">    :param bool verbose: Bool, increase output verbosity, print out progress of your job, Default: False.</span>

<span class="sd">    :return: Return a Prerank obj. All results store to  a dictionary, obj.results,</span>
<span class="sd">             where contains::</span>

<span class="sd">                 | {es: enrichment score,</span>
<span class="sd">                 |  nes: normalized enrichment score,</span>
<span class="sd">                 |  p: P-value,</span>
<span class="sd">                 |  fdr: FDR,</span>
<span class="sd">                 |  size: gene set size,</span>
<span class="sd">                 |  matched_size: genes matched to the data,</span>
<span class="sd">                 |  genes: gene names from the data set}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pre</span> <span class="o">=</span> <span class="n">Prerank</span><span class="p">(</span><span class="n">rnk</span><span class="p">,</span> <span class="n">gene_sets</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">pheno_pos</span><span class="p">,</span> <span class="n">pheno_neg</span><span class="p">,</span>
                  <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">permutation_num</span><span class="p">,</span> <span class="n">weighted_score_type</span><span class="p">,</span>
                  <span class="n">ascending</span><span class="p">,</span> <span class="n">processes</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">graph_num</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">pre</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">pre</span></div>



<div class="viewcode-block" id="replot"><a class="viewcode-back" href="../../run.html#gseapy.replot">[docs]</a><span class="k">def</span> <span class="nf">replot</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="n">outdir</span><span class="o">=</span><span class="s1">&#39;GSEA_Replot&#39;</span><span class="p">,</span> <span class="n">weighted_score_type</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
           <span class="n">min_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">max_size</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mf">6.5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;pdf&#39;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The main fuction to reproduce GSEA desktop outputs.</span>

<span class="sd">    :param indir: GSEA desktop results directory. In the sub folder, you must contain edb file foder.</span>
<span class="sd">    :param outdir: Output directory.</span>
<span class="sd">    :param float weighted_score_type: weighted score type. choose from {0,1,1.5,2}. Default: 1.</span>
<span class="sd">    :param list figsize: matplotlib output figure figsize. Defult: [6.5,6].</span>
<span class="sd">    :param str format: matplotlib output figure format. Default: &#39;pdf&#39;.</span>
<span class="sd">    :param int min_size: min size of input genes presented in Gene Sets. Default: 3.</span>
<span class="sd">    :param int max_size: max size of input genes presented in Gene Sets. Default: 5000.</span>
<span class="sd">                     you will not encourage to use min_size, or max_size argment in :func:`replot` function.</span>
<span class="sd">                     Because gmt file has already been filter.</span>
<span class="sd">    :param verbose: Bool, increase output verbosity, print out progress of your job, Default: False.</span>

<span class="sd">    :return: Generate new figures with seleted figure format. Default: &#39;pdf&#39;.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rep</span> <span class="o">=</span> <span class="n">Replot</span><span class="p">(</span><span class="n">indir</span><span class="p">,</span> <span class="n">outdir</span><span class="p">,</span> <span class="n">weighted_score_type</span><span class="p">,</span>
                 <span class="n">min_size</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">figsize</span><span class="p">,</span> <span class="nb">format</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>
    <span class="n">rep</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>

    <span class="k">return</span></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Zhuoqing Fang.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'0.9.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>